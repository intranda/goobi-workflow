<ui:composition
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:c="http://java.sun.com/jstl/core">
    <!-- Bootstrap 5 -->
    <script src="template/js/bootstrap.bundle.min.js?v=#{HelperForm.buildVersion}"></script>
    <!-- HC-Sticky -->
    <script src="template/js/static/hc-sticky.js?v=#{HelperForm.buildVersion}"></script>

    <!-- INTRANDA JS -->
    <script src="template/js/static/intranda.js?v=1.2"></script>

    <!-- jQuery -->
    <h:outputScript library="primefaces" name="jquery/jquery.js?v=#{HelperForm.buildVersion}" />

    <!-- Reactive rx -->
    <script src="template/js/static/reactiveX/rxjs.umd.min.js"></script>

    <!-- shortcuts ==> used in several templates (also plugins) + _metseditor.xhtml -->
    <script src="template/js/static/jquery.hotkeys.js?v=#{HelperForm.buildVersion}"></script>

    <!-- GW custom JS -->
    <script>
        // WHAT DOES IT DO?
        window.myfaces = window.myfaces || {};
        myfaces.config = myfaces.config || {};
        //set the config part
        myfaces.config.no_portlet_env = true;
    </script>
    <h:outputScript name="js/dist/legacy.min.js?v=#{HelperForm.buildVersion}" />
    <h:outputScript name="js/dist/main.min.js?v=#{HelperForm.buildVersion}" />
    <c:forEach
        items="#{ThemeBean.themePlugins}"
        var="plugin"
		>
        <c:forEach
                items="#{plugin.getJsPaths()}"
                var="jsPath"
        >
            <script
                    src="#{HelperForm.applicationWebsiteUrl}#{plugin.id}/js/#{jsPath}"
                    type="text/javascript"
            ></script>
        </c:forEach>
    </c:forEach>
    <script id="gwConfig" type="application/json">
        {
            "currentView": "#{Metadaten.modusAnsicht}",
            "readOnlyMode": "#{Metadaten.nurLesenModus}",
            "autoSaveInterval": "#{LoginForm.myBenutzer.metsEditorTime}",
            "baseUrl": "#{HelperForm.servletPathWithHostAsUrl}",
            "openImageTitleText": "#{msgs.mets_showThisImage}",
            "setRepresentativeImageText": "#{msgs.mets_setRepresentativeImage}",
            "displayImageArea": #{Metadaten.bildAnzeigen},
            "navigationShortcut": "#{LoginForm.myBenutzer.shortcutPrefix}",
            "metseditor": {
                "thumbnails": {
                    "maxParallelRequests": "#{Metadaten.maxParallelThumbnailRequests}"
                }
            },
            "isInitialLoad": "true",
            "reloadObject": "false"
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const configElement = document.getElementById('gwConfig');
            const goobiWorkflowConfig = configElement ? JSON.parse(configElement.textContent) : {};
        });
        // wrapping these initializations in an event listener is a workaround as we can't defer inline JS
        window.addEventListener('DOMContentLoaded', () => {
            (() => {
                document.querySelectorAll('.grow-wrap').forEach( (wrap) => {
                    const textarea = wrap.querySelector('textarea');
                    if (!textarea) {
                        return;
                    }
                    // Sync wrap and textarea on load
                    wrap.dataset.content = textarea.value;
                    textarea.addEventListener('input', () => {
                        wrap.dataset.content = textarea.value;
                    });
                });
            })();
        })
        if(typeof faces !== "undefined") {
	        faces.ajax.addOnEvent((data) => {
	            const ajaxstatus = data.status;
	            if (ajaxstatus === 'success') {
                    const configElement = document.getElementById('gwConfig');
                    const goobiWorkflowConfig = configElement ? JSON.parse(configElement.textContent) : {};
                    goobiWorkflowConfig.reloadObject = data?.source?.dataset.renderimage === 'true';
                    goobiWorkflowConfig.isInitialLoad = false;
                    goobiWorkflowJS.init( goobiWorkflowConfig );
	                document.querySelectorAll('.grow-wrap').forEach( (wrap) => {
	                    // Sync wrap and textarea on load
	                    const textarea = wrap.querySelector('textarea');
	                    if (!textarea) {
	                        return;
	                    }
	                    wrap.dataset.content = textarea.value;
	                    textarea.addEventListener('input', () => {
	                        wrap.dataset.content = textarea.value;
	                    });
	                });
	            }
	        });
        }
    </script>
</ui:composition>